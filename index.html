<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Bed Stuy Block Associations</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            color: black;
            padding: 20px;
            z-index: 2;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            margin: 0 0 5px 0;
            font-size: 30px;
            font-weight: 800;
        }
        
        .header p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Search Box */
        .search-box {
            position: absolute;
            top: 120px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1;
            width: 320px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
        }
        
        .search-box h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: black;
        }
        
        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #7DBBBB;
        }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .result-item:hover {
            border-color: #7DBBBB;
            background: #f0f7f7;
        }
        
        .result-item strong {
            display: block;
            color: black;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .result-item small {
            color: #666;
            font-size: 12px;
        }
        
        /* Association Info Panel */
        .info-panel {
            position: absolute;
            top: 120px;
            right: 20px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1;
            width: 350px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            display: none;
        }
        
        .info-panel.active {
            display: block;
        }
        
        .info-panel h2 {
            margin: 0 0 20px 0;
            font-size: 20px;
            color: black;
            padding-right: 30px;
        }
        
        .close-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: black;
        }
        
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-label {
            font-size: 14px;
            text-transform: uppercase;
            color: #999;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .info-value {
            font-size: 12px;
            color: black;
            line-height: 1.5;
        }
        
        .info-value a {
            color: black;
            text-decoration: none;
        }
        
        .info-value a:hover {
            text-decoration: underline;
        }
        
        .placeholder-text {
            color: #999;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px;
                padding-bottom: 12px;
            }
            
            .header h1 {
                font-size: 25px;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 14px;
                margin-bottom: 12px;
            }
            
            .search-box {
                position: static;
                background: transparent;
                padding: 0;
                box-shadow: none;
                width: 100%;
                max-height: none;
                margin-top: 0;
            }
            
            .search-box h3 {
                display: none;
            }
            
            .search-input {
                padding: 10px;
                font-size: 14px;
                margin-bottom: 0;
            }
            
            .search-results {
                position: absolute;
                left: 15px;
                right: 15px;
                top: 100%;
                margin-top: 5px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-height: 40vh;
                z-index: 10;
            }
            
            .info-panel {
                position: fixed;
                top: auto;
                bottom: 10px;
                left: 10px;
                right: 10px;
                width: calc(100% - 20px);
                border-radius: 12px;
                max-height: 30vh;
                padding: 20px;
                transform: translateY(calc(100% + 10px));
                transition: transform 0.3s ease-out;
                overflow-y: auto;
            }
            
            .info-panel.active {
                transform: translateY(0);
            }
            
            .info-panel h2 {
                font-size: 20px;
            }
            
            .result-item {
                padding: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 12px;
                padding-bottom: 10px;
            }
            
            .header h1 {
                font-size: 25px;
                margin-bottom: 6px;
            }
            
            .header p {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .search-input {
                padding: 8px;
                font-size: 12px;
            }
            
            .search-results {
                left: 12px;
                right: 12px;
            }
            
            .info-panel {
                max-height: 30vh;
                padding: 15px;
            }
        }
    </style>
</head>
<body>

<!-- Header -->
<div class="header">
    <h1>Bed Stuy Block Associations</h1>
    <p>Find the community organization representing your block in Bedford-Stuyvesant</p>
    
    <!-- Search Box -->
    <div class="search-box">
        <h3>Click or Search Your Street</h3>
        <input 
            type="text" 
            class="search-input" 
            id="street-search" 
            placeholder="Type your street name (e.g., Decatur)..."
        >
        
        <div class="search-results" id="search-results"></div>
    </div>
</div>

<!-- Info Panel -->
<div class="info-panel" id="info-panel">
    <button class="close-btn" id="close-panel">Ã—</button>
    <h2 id="association-name">Block Association Name</h2>
    
    <div class="info-section">
        <div class="info-label">Street Location</div>
        <div class="info-value" id="street-location"></div>
    </div>
    
    <div class="info-section">
        <div class="info-label">President</div>
        <div class="info-value placeholder-text" id="president">Data needed</div>
    </div>
    
    <div class="info-section">
        <div class="info-label">Contact Email</div>
        <div class="info-value placeholder-text" id="email">Data needed</div>
    </div>
    
    <div class="info-section">
        <div class="info-label">Phone</div>
        <div class="info-value placeholder-text" id="phone">Data needed</div>
    </div>
    
    <div class="info-section">
        <div class="info-label">Website</div>
        <div class="info-value placeholder-text" id="website">Data needed</div>
    </div>
    
    <div class="info-section">
        <div class="info-label">Meeting Schedule</div>
        <div class="info-value placeholder-text" id="meetings">Data needed</div>
    </div>
    
    <div class="info-section">
        <div class="info-label">Year Founded</div>
        <div class="info-value placeholder-text" id="year-founded">Data Unavailable</div>
    </div>
</div>

<!-- Map Container -->
<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGVsYW5leWNvbm5vciIsImEiOiJjbTRnM2Q1ZGkxZzhuMmpvbXByY2wwaDgwIn0.HSEo0pqv9ZN6DorMNmTB8A';

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/delaneyconnor/cmie08kl4000901s32neo2nsz',
    center: [-73.9351, 40.6872],
    zoom: 14
});

map.addControl(new mapboxgl.NavigationControl(), 'bottom-left');

let allFeatures = [];
let hoveredSegmentId = null;
let selectedSegmentId = null;

map.on('load', function() {
    // Set up initial paint properties with default values
    map.setPaintProperty('block_associations', 'line-color', '#FFFFFF');
    map.setPaintProperty('block_associations', 'line-width', 4);
    map.setPaintProperty('block_associations', 'line-opacity', 1);
    map.setPaintProperty('block_associations', 'line-cap', 'round');
    map.setPaintProperty('block_associations', 'line-join', 'round');
    
    map.once('idle', function() {
        loadFeatures();
    });
});

function loadFeatures() {
    const features = map.querySourceFeatures('composite', {
        sourceLayer: 'block_associations'
    });
    
    if (features && features.length > 0) {
        allFeatures = features;
        console.log(`Loaded ${allFeatures.length} features for search`);
    } else {
        allFeatures = map.queryRenderedFeatures({ layers: ['block_associations'] });
        console.log(`Loaded ${allFeatures.length} rendered features for search`);
    }
}

// Hover effect
map.on('mousemove', 'block_associations', function(e) {
    if (e.features.length > 0) {
        const newHoveredId = e.features[0].properties['Event.ID'];
        
        // Only update hover if we're not hovering over the selected segment
        if (hoveredSegmentId !== newHoveredId && selectedSegmentId !== newHoveredId) {
            hoveredSegmentId = newHoveredId;
            updateMapColors();
        }
    }
    map.getCanvas().style.cursor = 'pointer';
});

map.on('mouseleave', 'block_associations', function() {
    map.getCanvas().style.cursor = '';
    hoveredSegmentId = null;
    updateMapColors();
});

// Click handler - improved to be more precise
map.on('click', function(e) {
    // Use a smaller bounding box for more precise clicks
    const bbox = [
        [e.point.x - 5, e.point.y - 5],
        [e.point.x + 5, e.point.y + 5]
    ];
    
    const features = map.queryRenderedFeatures(bbox, {
        layers: ['block_associations']
    });
    
    if (features.length > 0) {
        // Take only the first (topmost) feature
        const clickedFeature = features[0];
        const newSelectedId = clickedFeature.properties['Event.ID'];
        
        // Only update if it's a different segment
        if (selectedSegmentId !== newSelectedId) {
            selectedSegmentId = newSelectedId;
            hoveredSegmentId = null;
            updateMapColors();
            showAssociationInfo(clickedFeature.properties);
        }
    } else {
        // Clicked outside - deselect
        if (selectedSegmentId !== null) {
            selectedSegmentId = null;
            hoveredSegmentId = null;
            updateMapColors();
            document.getElementById('info-panel').classList.remove('active');
        }
    }
});

function updateMapColors() {
    const highlightColor = '#f03800';
    const defaultColor = '#FFFFFF';
    
    // Pass the actual values directly into the expression
    map.setPaintProperty('block_associations', 'line-color', [
        'case',
        ['==', ['get', 'Event.ID'], selectedSegmentId || -999999],
        highlightColor,
        ['==', ['get', 'Event.ID'], hoveredSegmentId || -999999],
        highlightColor,
        defaultColor
    ]);
    
    map.setPaintProperty('block_associations', 'line-width', [
        'case',
        ['==', ['get', 'Event.ID'], selectedSegmentId || -999999],
        10,
        ['==', ['get', 'Event.ID'], hoveredSegmentId || -999999],
        10,
        4
    ]);
}

// Search functionality
const searchInput = document.getElementById('street-search');
const searchResults = document.getElementById('search-results');

searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    
    if (searchTerm.length < 2) {
        searchResults.innerHTML = '';
        return;
    }
    
    if (allFeatures.length === 0) {
        loadFeatures();
    }
    
    const results = allFeatures.filter(feature => {
        const location = (feature.properties['Event.Location'] || '').toLowerCase();
        const name = (feature.properties['Event.Name'] || '').toLowerCase();
        return location.includes(searchTerm) || name.includes(searchTerm);
    });
    
    const uniqueResults = [];
    const seen = new Set();
    
    results.forEach(feature => {
        const location = feature.properties['Event.Location'];
        if (location && !seen.has(location)) {
            seen.add(location);
            uniqueResults.push(feature);
        }
    });
    
    displaySearchResults(uniqueResults.slice(0, 8));
});

function displaySearchResults(results) {
    if (results.length === 0) {
        searchResults.innerHTML = '<div style="padding: 10px; color: #999; font-size: 13px;">No results found</div>';
        return;
    }
    
    searchResults.innerHTML = results.map(feature => {
        const props = feature.properties;
        return `
            <div class="result-item" data-props='${JSON.stringify(props)}'>
                <strong>${extractAssociationName(props['Event.Name'])}</strong>
                <small>${props['Event.Location']}</small>
            </div>
        `;
    }).join('');
    
    document.querySelectorAll('.result-item').forEach(item => {
        item.addEventListener('click', function() {
            const props = JSON.parse(this.getAttribute('data-props'));
            selectResult(props);
        });
    });
}

function selectResult(props) {
    selectedSegmentId = props['Event.ID'];
    hoveredSegmentId = null;
    updateMapColors();
    showAssociationInfo(props);
    searchInput.value = '';
    searchResults.innerHTML = '';
    
    if (props['Event.Location']) {
        map.flyTo({
            center: [-73.9351, 40.6872],
            zoom: 15,
            duration: 1000
        });
    }
}

function extractAssociationName(eventName) {
    if (!eventName) return 'Block Association';
    
    let name = eventName
        .replace(/\d{4}/g, '')
        .trim();
    
    const assocIndex = name.toLowerCase().indexOf('association');
    if (assocIndex !== -1) {
        name = name.substring(0, assocIndex + 11);
    }
    
    name = name
        .replace(/\bAve\b\.?/gi, 'Avenue')
        .replace(/\bSt\b\.?/gi, 'Street')
        .replace(/\bBlvd\b\.?/gi, 'Boulevard')
        .replace(/\bRd\b\.?/gi, 'Road')
        .replace(/\bDr\b\.?/gi, 'Drive')
        .replace(/\bCt\b\.?/gi, 'Court')
        .replace(/\bPl\b\.?/gi, 'Place')
        .replace(/\bLn\b\.?/gi, 'Lane')
        .replace(/\bPkwy\b\.?/gi, 'Parkway');
    
    name = name.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
    
    return name.trim();
}

function showAssociationInfo(props) {
    const panel = document.getElementById('info-panel');
    const associationName = extractAssociationName(props['Event.Name']);
    
    document.getElementById('association-name').textContent = associationName;
    document.getElementById('street-location').textContent = props['Event.Location'] || 'Location not available';
    
    document.getElementById('president').innerHTML = '<span class="placeholder-text">Data Unavailable</span>';
    document.getElementById('email').innerHTML = '<span class="placeholder-text">Data Unavailable</span>';
    document.getElementById('phone').innerHTML = '<span class="placeholder-text">Data Unavailable</span>';
    document.getElementById('website').innerHTML = '<span class="placeholder-text">Data Unavailable</span>';
    document.getElementById('meetings').innerHTML = '<span class="placeholder-text">Data Unavailable</span>';
    document.getElementById('year-founded').innerHTML = '<span class="placeholder-text">Data Unavailable</span>';
    
    panel.classList.add('active');
}

// Close panel
document.getElementById('close-panel').addEventListener('click', function() {
    document.getElementById('info-panel').classList.remove('active');
    selectedSegmentId = null;
    hoveredSegmentId = null;
    updateMapColors();
});

</script>

</body>
</html>